#include "public.h"
/*code is far away from bug with the animal protecting
  *  ┏┓　　　┏┓
  *┏┛┻━━━┛┻┓
  *┃　　　　　　　┃
  *┃　　　━　　　┃
  *┃　┳┛　┗┳　┃
  *┃　　　　　　　┃
  *┃　　　┻　　　┃
  *┃　　　　　　　┃
  *┗━┓　　　┏━┛
  *　　┃　　　┃神兽保佑
  *　　┃　　　┃代码无BUG！
  *　　┃　　　┗━━━┓
  *　　┃　　　　　　　┣┓
  *　　┃　　　　　　　┏┛
  *　　┗┓┓┏━┳┓┏┛
  *　　　┃┫┫　┃┫┫
  *　　　┗┻┛　┗┻┛
  *
  *




      **
      *
      *----------Dragon be here!----------

              ┏┓　　　┏┓
            ┏┛┻━━━┛┻┓
            ┃　　　　　　　┃
            ┃　　　━　　　┃
            ┃　┳┛　┗┳　┃
            ┃　　　　　　　┃
            ┃　　　┻　　　┃
            ┃　　　　　　　┃
            ┗━┓　　　┏━┛
                    ┃　　　┃
                    ┃　　　┃
                    ┃　　　┗━━━┓
                    ┃　　　　　　　┣┓
                    ┃　　　　　　　┏┛
                    ┗┓┓┏━┳┓┏┛
                      ┃┫┫　┃┫┫
                      ┗┻┛　┗┻┛
          ━━━━━━神兽出没━━━━━━ *

      **

                 ┏┓　　　┏┓
               ┏┛┻━━━┛┻┓
               ┃　　　　　　　┃
               ┃　　　━　　　┃
               ┃　＞　　　＜　┃
               ┃　　　　　　　┃
               ┃...　⌒　...　┃
               ┃　　　　　　　┃
               ┗━┓　　　┏━┛
                       ┃　　　┃　Code is far away from bug with the animal protecting
                       ┃　　　┃ 神兽保佑,代码无bug
                       ┃　　　┃
                       ┃　　　┃
                       ┃　　　┃
                       ┃　　　┃
                       ┃　　　┗━━━┓
                       ┃　　　　　　　┣┓
                       ┃　　　　　　　┏┛
                       ┗┓┓┏━┳┓┏┛
                         ┃┫┫　┃┫┫
                         ┗┻┛　┗┻┛ *

      **
      *　　　　　　　　┏┓　　　┏┓+ +
      *　　　　　　　┏┛┻━━━┛┻┓ + +
      *　　　　　　　┃　　　　　　　┃
      *　　　　　　　┃　　　━　　　┃ ++ + + +
      *              ┃  ????━????  ┃+
      *　　　　　　　┃　　　　　　　┃ +
      *　　　　　　　┃　　　┻　　　┃
      *　　　　　　　┃　　　　　　　┃ + +
      *　　　　　　　┗━┓　　　┏━┛
      *　　　　　　　　　┃　　　┃
      *　　　　　　　　　┃　　　┃ + + + +
      *　　　　　　　　　┃　　　┃　　　　Code is far away from bug with the animal protecting
      *　　　　　　　　　┃　　　┃ + 　　　　神兽保佑,代码无bug
      *　　　　　　　　　┃　　　┃
      *　　　　　　　　　┃　　　┃　　+
      *　　　　　　　　　┃　 　 ┗━━━┓ + +
      *　　　　　　　　　┃ 　　　　　　 ┣┓
      *　　　　　　　　　┃ 　　　　　 　┏┛
      *　　　　　　　　　┗┓┓┏━┳┓┏┛ + + + +
      *　　　　　　　　　　┃┫┫　┃┫┫
      *　　　　　　　　　　┗┻┛　┗┻┛+ + + +
      */


//1只羊 == one sheep
//2只羊 == two sheeps
//3只羊 == three sheeps
//4只羊 == four sheeps
//5只羊 == five sheeps
//6只羊 == six sheeps
//7只羊 == seven sheeps
//8只羊 == eight sheeps
//9只羊 == nine sheeps
//10只羊 == ten sheeps
//11只羊 == eleven sheeps
//12只羊 == twelve sheeps
//13只羊 == thirteen sheeps
//14只羊 == fourteen sheeps
//15只羊 == fifteen sheeps
//16只羊 == sixteen sheeps
//17只羊 == seventeen sheeps
//18只羊 == eighteen sheeps
//19只羊 == nineteen sheeps
//20只羊 == twenty sheeps
//21只羊 == twenty one sheeps
//22只羊 == twenty two sheeps
//23只羊 == twenty three sheeps
//24只羊 == twenty four sheeps
//25只羊 == twenty five sheeps
//26只羊 == twenty six sheeps
//27只羊 == twenty seven sheeps
//28只羊 == twenty eight sheeps
//29只羊 == twenty nine sheeps
//30只羊 == thirty sheeps
//现在瞌睡了吧，好了，不要再改下面的代码了，睡觉咯~~


/**
 *      出生
 *       ||
 *       ||
 *      \  /
 *       \/
 *      青年
 * （年龄 = rand(20,25))）    《==============
 *       ||                                                                 ||
 *       ||                                                                 ||
 *       ||        祝福所有开发工作者                         ||
 *       ||            永远年轻                                       ||
 *       ||                                                                 ||
 *      \  /                                                                ||
 *       \/                                                                 ||
 *（ 20 <= 年龄 <= 25）        ===============
 *       ||
 *       ||
 *      \  /
 *       \/
 *     等死状态
 */
void Timer0Init(void)		//1微秒@11.0592MHz
{
	AUXR |= 0x80;		//定时器时钟1T模式
	TMOD &= 0xF0;		//设置定时器模式
	TMOD |= 0x01;		//设置定时器模式
	TL0 = 0xF5;		//设置定时初值
	TH0 = 0xFF;		//设置定时初值
	TF0 = 0;		//清除TF0标志
	TR0 = 1;		//定时器0开始计时
}
void STCInit(void)
{
	IE2 = IE2|0x01; //Enable UART2 interrupt
	ES=1; //开串口中断
	CR = 1;//PCA timer start run
	ET0=1;//定时器0 中断
	EA=1;
}
void Uart0Init(int BaudRate)     //@11.0592MHz
{
	PCON &= 0x7F;		//波特率不倍速
	SCON = 0x50;		//8位数据,可变波特率
	AUXR |= 0x40;		//定时器1时钟为Fosc,即1T
	AUXR &= 0xFE;		//串口1选择定时器1为波特率发生器
	TMOD &= 0x0F;		//清除定时器1模式位
	TMOD |= 0x20;		//设定定时器1为8位自动重装方式

    switch(BaudRate)
    {
    case 2400:
        TL1 = 0x70;		//设定定时初值
		TH1 = 0x70;		//设定定时器重装值
        break;
    case 4800:
      	TL1 = 0xB8;		//设定定时初值
		TH1 = 0xB8;		//设定定时器重装值
        break;
    case 9600:
        TL1 = 0xDC;		//设定定时初值
		TH1 = 0xDC;		//设定定时器重装值
        break;
    case 19200:
        TL1 = 0xEE;		//设定定时初值
		TH1 = 0xEE;		//设定定时器重装值
        break;
    default://默认波特率9600
        TL1 = 0xDC;		//设定定时初值
		TH1 = 0xDC;		//设定定时器重装值
        break;
    }
	ET1 = 0;		//禁止定时器1中断
	TI = 0;
	TR1 = 1;		//启动定时器1
}

void Uart1Init(int BaudRate)     //@11.0592MHz
{
	AUXR &= 0xF7;		//波特率不倍速
	S2CON = 0x50;		//8位数据,可变波特率
	AUXR |= 0x04;		//独立波特率发生器时钟为Fosc,即1T
    switch(BaudRate)
    {
    case 2400:
        BRT = 0x70;		//设定独立波特率发生器重装值
        break;
    case 4800:
      	BRT = 0xB8;		//设定独立波特率发生器重装值
        break;
    case 9600:
        BRT = 0xDC;		//设定独立波特率发生器重装值
        break;
    case 19200:
        BRT = 0xEE;		//设定独立波特率发生器重装值
        break;
    default://默认波特率9600
        BRT = 0xDC;		//设定独立波特率发生器重装值
        break;
    }
	S2CON &= ~S2TI;
	AUXR |= 0x10;		//启动独立波特率发生器
}
void PCA_Inti(void)
{
    CCON = 0;                       //Initial PCA control register
    //PCA timer stop running
    //Clear CF flag
    //Clear all module interrupt flag
    CL = 0;                         //Reset PCA base timer
    CH = 0;
    CMOD = 0x00;                    //Set PCA timer clock source as Fosc/12
    //Disable PCA timer overflow interrupt
    PCA_Value = T100Hz;
    CCAP0L = PCA_Value;
    CCAP0H = PCA_Value >> 8;            //Initial PCA module-0
    PCA_Value += T100Hz;
	TimeCount=0;
    TimeOut=0;
	LedTime=0;
	
    CCAPM0 = 0x49;                  //PCA module-0 work in 16-bit timer mode and enable PCA interrupt
}
void Delay5000ms()		//@11.0592MHz
{
	unsigned char i, j, k;

	i = 211;
	j = 30;
	k = 11;
	do
	{
		do
		{
			while (--k);
		} while (--j);
	} while (--i);
}

data volatile unsigned int LedTime;//超时计数
data volatile int TimeCount;//时间计数
data volatile unsigned int TimeOut;//超时计数
data volatile unsigned int PCA_Value;//PCA timer overflow interrupt
data volatile UT100TaskVar UTTaskVar;
data volatile BUFFERRING Com1BuffErRing,Com2BuffErRing;
data volatile unsigned char Com1_Rec_Buff[Com1_Rec_Buff_MaxLen];//串口接受数据缓存
volatile unsigned char Com2_Rec_Buff[Com2_Rec_Buff_MaxLen];//串口接受数据缓存
volatile unsigned char ComBuff[Com2_Rec_Buff_MaxLen];//串口动态内存区域
void main(){
	UPS_Test=Alarm=UPS_ShutDown=0;
	memset(&UTTaskVar,0,sizeof(UTTaskVar));
	Timer0Init();
	PCA_Inti();
	Uart0Init(2400);
	Uart1Init(2400);
	STCInit();
	//初始化串口1缓冲区,缓冲区满丢弃数据
	InitBufferRing(&Com1BuffErRing,Com1_Rec_Buff,sizeof(Com1_Rec_Buff),0);
	//初始化串口2缓冲区,缓冲区满丢弃数据
	InitBufferRing(&Com2BuffErRing,Com2_Rec_Buff,sizeof(Com2_Rec_Buff),0);
	Delay5000ms();
	UPS_Test=Alarm=UPS_ShutDown=1;
	while(1){
		PollUps();
		if(UTTaskVar.Com1_Rec_OK==1){
			//回复上位机查询指令
			RcvDev();
		}
		
		if(UTTaskVar.PollIndex==1){
			if(UTTaskVar.Com2_Rec_OK==0)
			{
				if(TimeOut>100){
					TimeOut=0;//不恢复0 会导致马上掉线
					SET_BIT(UTTaskVar.Task_flag,4);//可发送下一个查询指令
					Alarm=0;
					}
			}
			if(UTTaskVar.Com2_Rec_OK==1)
			{
				Verify();
			}
		}else{
		SET_BIT(UTTaskVar.Task_flag,4);//可发送下一个查询指令
		TimeOut=0;
		}
	}
}